version: 2
jobs:
  # Install PipelineWise components and full test environment
  build:

    # Required docker containers
    docker:
      - image: circleci/python:3.6.2
        environment:
          DB_TAP_MYSQL_HOST: db_mysql_source
          DB_TAP_MYSQL_PORT: ${DB_TAP_MYSQL_PORT}
          DB_TAP_MYSQL_USER: ${DB_TAP_MYSQL_USER}
          DB_TAP_MYSQL_PASSWORD: ${DB_TAP_MYSQL_PASSWORD}
          DB_TAP_MYSQL_DB: ${DB_TAP_MYSQL_DB}

          DB_TAP_POSTGRES_HOST: db_postgres_source
          DB_TAP_POSTGRES_PORT: ${DB_TAP_POSTGRES_PORT}
          DB_TAP_POSTGRES_USER: ${DB_TAP_POSTGRES_USER}
          DB_TAP_POSTGRES_PASSWORD: ${DB_TAP_POSTGRES_PASSWORD}
          DB_TAP_POSTGRES_DB: ${DB_TAP_POSTGRES_DB}

          DB_TARGET_POSTGRES_HOST: db_postgres_dwh
          DB_TARGET_POSTGRES_PORT: ${DB_TARGET_POSTGRES_PORT}
          DB_TARGET_POSTGRES_USER: ${DB_TARGET_POSTGRES_USER}
          DB_TARGET_POSTGRES_PASSWORD: ${DB_TARGET_POSTGRES_PASSWORD}
          DB_TARGET_POSTGRES_DB: ${DB_TARGET_POSTGRES_DB}

      # PostgreSQL service container image used as test source database
      - image: postgres:11.4
        name: db_postgres_source
        environment:
          POSTGRES_USER: ${DB_TAP_POSTGRES_USER}
          POSTGRES_PASSWORD: ${DB_TAP_POSTGRES_PASSWORD}
          POSTGRES_DB: ${DB_TAP_POSTGRES_DB}

       # MariaDB service container image used as test source database
      - image: mariadb:10.2.26
        name: db_mysql_source
        environment:
          MYSQL_ROOT_PASSWORD: ${DB_TAP_MYSQL_ROOT_PASSWORD}
          MYSQL_USER: ${DB_TAP_MYSQL_USER}
          MYSQL_PASSWORD: ${DB_TAP_MYSQL_PASSWORD}
          MYSQL_DATABASE: ${DB_TAP_MYSQL_DB}

      # PostgreSQL service container image used as test source database
      - image: postgres:11.4
        name: db_postgres_dwh
        environment:
          POSTGRES_USER: ${DB_TARGET_POSTGRES_USER}
          POSTGRES_PASSWORD: ${DB_TARGET_POSTGRES_PASSWORD}
          POSTGRES_DB: ${DB_TARGET_POSTGRES_DB}

    steps:
    #  - checkout

      # Build source databases for integration tests
      - run:
          name: 'Build source databases for integration tests'
          command: |
            sudo apt-get update
            sudo apt install mariadb-client postgresql-client
            #./.circleci/tap_postgres_test_db.sh
            #./.circleci/tap_mysql_test_db.sh
      # Installing PipelineWise components and connectors
      #- run:
      #    name: 'Installing PipelineWise components and connectors'
      #    command: ./install.sh --acceptlicenses

  #test:
  #  steps:
      # Unit Tests and Coverage
  #    - run:
  #        name: 'Unit Tests and Coverage'
  #        command: |
  #          . .virtualenvs/pipelinewise/bin/activate
  #          pip install pytest coverage
  #          coverage run -m pytest --disable-pytest-warnings
  #          coverage report
  #          coverage html -d coverage_html

  # For documentation deployment. You'll need the following environment vars
  # in your Circle CI settings, otherwise this will not work.
  #
  # GH_NAME (your git username)
  # GH_EMAIL (your git email)
  # GH_TOKEN (the personal Git token with pushes enabled)
  #deploy-doc:
  #  docker:
  #    - image: circleci/python:3.6.2
  #  working_directory: ~/gh_doc_automation
  #  steps:
  #    - checkout
  #    - run: .circleci/publish_docs.sh

workflows:
  version: 2
  build:
    jobs:
      - build

  #deploy:
  #  jobs:
  #    - deploy-doc